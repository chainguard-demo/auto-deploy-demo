name: updates

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

env:
  # Core demo images (set these to the pair you want to demonstrate)
  DEMO_OLD_IMAGE: "cgr.dev/cgr-demo.com/python:3.12.12"
  DEMO_NEW_IMAGE: "cgr.dev/cgr-demo.com/python:3.12-202508222152"

  # Toggle scanners
  SCAN_WITH_GRYPE: "true"
  SCAN_WITH_PRISMA_CLOUD: "true"
  OBJC_DISABLE_INITIALIZE_FORK_SAFETY: "YES"

permissions: {}

jobs:
  check-for-fixes:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      security-events: write
      id-token: write

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76
        with:
          egress-policy: audit

      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683

      - name: Setup Go environment
        uses: actions/setup-go@41dfa10bad2bb2ae585af6ee5bb4d7d973ad74ed
        with:
          cache: false

      # Token used for PR creation etc. (your existing Octo STS setup)
      - uses: octo-sts/action@6177b4481c00308b3839969c3eca88c96a91775f
        id: octo-sts
        with:
          scope: chainguard-demo/auto-deploy-demo
          identity: updates

      - name: Install Crane
        run: go install github.com/google/go-containerregistry/cmd/crane@latest

      - name: Install Grype (pinned release)
        if: env.SCAN_WITH_GRYPE == 'true'
        run: |
          set -euo pipefail
          GRYPE_VERSION="v0.91.2"
          curl -sSfL "https://github.com/anchore/grype/releases/download/${GRYPE_VERSION}/grype_${GRYPE_VERSION#v}_linux_amd64.tar.gz" \
            | tar -xz -C /usr/local/bin grype
          grype version

      - name: Install Cosign
        uses: sigstore/cosign-installer@dc72c7d5c4d10cd6bcb8cf6e3fd625a9e5e537da

      - uses: chainguard-dev/setup-chainctl@8d93dcbef466d3cf3533f67084f52eb74ef9d262
        with:
          identity: "4cf15780a13a9b6576d8b357e6524554c8c12a18/a662f56b58103354"

      - name: Auth to Registry
        run: chainctl auth configure-docker

      - name: Set OLD_IMAGE / NEW_IMAGE from demo inputs
        run: |
          echo "OLD_IMAGE=${{ env.DEMO_OLD_IMAGE }}" >> "$GITHUB_ENV"
          echo "NEW_IMAGE=${{ env.DEMO_NEW_IMAGE }}" >> "$GITHUB_ENV"
          echo "OLD_IMAGE=${{ env.DEMO_OLD_IMAGE }}"
          echo "NEW_IMAGE=${{ env.DEMO_NEW_IMAGE }}"

      - name: Cosign verify new image signature
        run: |
          set -euo pipefail
          CATALOG_SYNCER="4cf15780a13a9b6576d8b357e6524554c8c12a18/c03040118377d88c"
          APKO_BUILDER="4cf15780a13a9b6576d8b357e6524554c8c12a18/ca93125e202f81f8"
          cosign verify \
            --certificate-oidc-issuer=https://issuer.enforce.dev \
            --certificate-identity-regexp="https://issuer.enforce.dev/(${CATALOG_SYNCER}|${APKO_BUILDER})" \
            "${{ env.NEW_IMAGE }}" | jq

      - name: Run chainctl images diff to open PR for Vuln Fixes
        id: diff_vulnerabilities
        run: |
          set -euo pipefail

          echo "FIX_CVE=false" >> "$GITHUB_ENV"
          echo "CVE_LIST=[]" >> "$GITHUB_ENV"

          echo "Running chainctl images diff..."
          set +e
          DIFF_OUTPUT="$(chainctl images diff "${{ env.OLD_IMAGE }}" "${{ env.NEW_IMAGE }}" --output json 2>&1)"
          RC=$?
          set -e

          echo "chainctl exit code: $RC"
          echo "$DIFF_OUTPUT"

          if [ $RC -ne 0 ]; then
            echo "chainctl images diff failed; skipping demo PR."
            exit 0
          fi

          # chainctl prints log lines + JSON; extract JSON starting at first "{"
          DIFF_JSON="$(echo "$DIFF_OUTPUT" | awk 'BEGIN{found=0} /^\{/{found=1} found{print}')"

          if ! echo "$DIFF_JSON" | jq -e . >/dev/null 2>&1; then
            echo "Diff output was not valid JSON; skipping demo PR."
            exit 0
          fi

          CVE_LIST_JSON="$(echo "$DIFF_JSON" | jq -c '[.vulnerabilities.removed[]? | .id]')"
          echo "CVE_LIST=$CVE_LIST_JSON" >> "$GITHUB_ENV"

          if [ "$(echo "$CVE_LIST_JSON" | jq 'length')" -gt 0 ]; then
            echo "Found removed vulns: $CVE_LIST_JSON"
            echo "FIX_CVE=true" >> "$GITHUB_ENV"
          else
            echo "No removed vulns; not opening PR."
          fi

      - name: Scan new image with Grype
        if: env.FIX_CVE == 'true' && env.SCAN_WITH_GRYPE == 'true'
        run: |
          set -euo pipefail
          grype "${{ env.NEW_IMAGE }}" -o sarif > grype-results.sarif

          SUMMARY="$(grype "${{ env.NEW_IMAGE }}" 2>&1 | head -n 80)"
          {
            echo "SARIF_SUMMARY<<EOF"
            echo "$SUMMARY"
            echo "EOF"
          } >> "$GITHUB_ENV"

      - name: Upload Grype SARIF results
        if: env.FIX_CVE == 'true' && env.SCAN_WITH_GRYPE == 'true'
        uses: github/codeql-action/upload-sarif@6bb031afdd8eb862ea3fc1848194185e076637e5
        with:
          sarif_file: grype-results.sarif

      - name: Pre-pull docker image for Prisma Cloud scan
        if: env.FIX_CVE == 'true' && env.SCAN_WITH_PRISMA_CLOUD == 'true'
        run: docker pull "${{ env.NEW_IMAGE }}"

      - name: Prisma Cloud image scan
        if: env.FIX_CVE == 'true' && env.SCAN_WITH_PRISMA_CLOUD == 'true'
        id: prismascan
        uses: PaloAltoNetworks/prisma-cloud-scan@124b48d8325c23f58a35da0f1b4d9a6b54301d05 # v1.6.7
        with:
          pcc_console_url: ${{ secrets.PCC_CONSOLE_URL }}
          pcc_user: ${{ secrets.PCC_USER }}
          pcc_pass: ${{ secrets.PCC_PASS }}
          image_name: "${{ env.NEW_IMAGE }}"

      - name: Upload Prisma Cloud SARIF file
        if: env.FIX_CVE == 'true' && env.SCAN_WITH_PRISMA_CLOUD == 'true'
        uses: github/codeql-action/upload-sarif@6bb031afdd8eb862ea3fc1848194185e076637e5
        with:
          sarif_file: ${{ steps.prismascan.outputs.sarif_file }}

      - name: Extract Prisma Cloud Console Link
        if: env.FIX_CVE == 'true' && env.SCAN_WITH_PRISMA_CLOUD == 'true'
        run: |
          set -euo pipefail
          results_file="${{ steps.prismascan.outputs.results_file }}"
          PRISMA_CLOUD_URL="$(cat "$results_file" | jq -r '.consoleURL')"
          echo "PRISMA_CLOUD_URL=$PRISMA_CLOUD_URL" >> "$GITHUB_ENV"

      # Always create a diff to PR when FIX_CVE=true
      - name: Write demo results to repo
        if: env.FIX_CVE == 'true'
        run: |
          set -euo pipefail
          mkdir -p demo-results
          {
            echo "timestamp=$(date -u +%FT%TZ)"
            echo "old_image=${{ env.OLD_IMAGE }}"
            echo "new_image=${{ env.NEW_IMAGE }}"
            echo "cves_removed=${{ env.CVE_LIST }}"
            echo "prisma_url=${{ env.PRISMA_CLOUD_URL }}"
          } > demo-results/last-run.txt

      - name: Run git diff
        if: env.FIX_CVE == 'true'
        id: create_pr_update
        run: |
          set -euo pipefail
          git diff --stat
          echo "create_pr_update=false" >> "$GITHUB_OUTPUT"
          if [[ $(git diff --stat) != '' ]]; then
            echo "create_pr_update=true" >> "$GITHUB_OUTPUT"
            echo "diff<<EOF" >> "$GITHUB_OUTPUT"
            git diff >> "$GITHUB_OUTPUT"
            echo "EOF" >> "$GITHUB_OUTPUT"
          fi

      - name: Create Pull Request
        if: env.FIX_CVE == 'true' && steps.create_pr_update.outputs.create_pr_update == 'true'
        uses: peter-evans/create-pull-request@5e914681df9dc83aa4e4905692ca88beb2f9e91f # v7.0.5
        with:
          token: ${{ steps.octo-sts.outputs.token }}
          commit-message: "Demo: record CVE fix results"
          title: "Demo: CVE fix detected for Python image"
          body: |
            **OLD_IMAGE:** `${{ env.OLD_IMAGE }}`
            **NEW_IMAGE:** `${{ env.NEW_IMAGE }}`

            **Removed CVEs (chainctl images diff):**
            ```json
            ${{ env.CVE_LIST }}
            ```

            <details>
            <summary>Grype Scan Summary</summary>

            ```text
            ${{ env.SARIF_SUMMARY }}
            ```
            </details>

            ## Prisma Cloud Console Link
            ${{ env.PRISMA_CLOUD_URL }}

            ## Changes
            <details>
            <summary>File Changes</summary>

            ```diff
            ${{ steps.create_pr_update.outputs.diff }}
            ```
            </details>
          labels: automated pr, cve, patch
          branch: "apply-cve-fix"
          delete-branch: true